var question = null;
var question_text = null;
var question_total_letter = 0;
var question_letter_number = -1;
var type_question_time = null;
$(document).on('click', '.review_add_step .np_step', function (el) {
		
		if($(this).attr('data-check')=='true')
		{
			   if(!$('.review_recommend_check').is(':checked'))
			   {
				   m_alert('warning','Hata','Lütfen tavsiye edip etmediğinizi seçiniz.','Tamam');
				   return false;
			   }
			   if($('.review_add_title').val()=='')
			   {
				   m_alert('warning','Hata','Lütfen inceleme başlığını yazınız.','Tamam');
				   return false;
			   }
			   if($('.review_point_select').val()=='0')
			   {
				   m_alert('warning','Hata','Lütfen ürün/hizmete verdiğiniz puanı seçiniz.','Tamam');
				   return false;
			   }

		}
		var step_type = $(this).attr('data-type');
		var all_step = $('.review_add_step');
		var step = $('.review_add_step.active').closest('.review_add_step');
		var next_step = $('.review_add_step.active').closest('.review_add_step').next();
		var prev_step = $('.review_add_step.active').closest('.review_add_step').prev();
		if(step_type=='next')
		{
			
			if(next_step.length)
			{
				all_step.removeClass('active');
				next_step.addClass('active');
				type_question();
			}
		}
		else
		{
			if(prev_step.length)
			{
				all_step.removeClass('active');
				prev_step.addClass('active');
				type_question();
			}
		}
    
		
});
function type_question()
{
	scroll_div(".review_form_container");
	question = $('.review_add_step.active .question');
	if(question.hasClass('completed'))
	{
		
	}
	else
	{
		
		question.show();
		question.addClass('completed');
		question.closest('.review_add_step').find('.question_after').show();
		
	}
}
$(document).on('keyup', '.review_add_step .review_add_content', function (el) {
		
		var word_count = $(this).closest('.review_add_step').find('.review_add_content_word_count');
		var need = $(this).closest('.review_add_step').find('.need').html();
		var total = $(this).val().split(/[\s\.\?]+/).length;
		$(this).closest('.review_add_step').find('.total').html(total);
		if(total>=need)
		{
			word_count.addClass('success');
		}
		else
		{
			word_count.removeClass('success');
		}
		
});

$(document).on('change', '.review_add_content_image', function(){
			var div = $(this);
            let reader = new FileReader();
            reader.onload = (e) => {
            $('#preview-image').attr('src', e.target.result);
			
				div.closest('.review_add_step').find('.review_content_image').attr('src',e.target.result);
            }
            reader.readAsDataURL(this.files[0]);
}); 
$(document).on('submit','.review_add_content_form', function(e){
			e.preventDefault();
			var form_data = new FormData($('.review_add_content_form')[0]);
			Swal.fire({
                    title: 'İnceleniyor...',
                    html: '<div style="text-align:center;"><i class="fa fa-spinner fa-spin"></i></div> Lütfen beklermisin incelemeyi kontrol ediyorum...',
					allowOutsideClick: false,
					allowEscapeKey: false,
                    showConfirmButton:false
            });
			$.ajax({
				type: 'POST',
				url: site_url+'/ajax',
				data: form_data,
				processData: false,
				contentType: false,
				dataType: 'json',
				cache: false,
				success: function(data) {
					if(data.status)
					{
						window.location.href=site_url+'/hesabim/incelemeler';
					}
					else
					{
						$('.review_add_content_result').html(error(data.msg));
						Swal.close();
						setTimeout(function(){ scroll_div(".review_form_container"); }, 750);
					}
				}
			})
});

$(document).on('submit','.revise_review_form', function(e){
			e.preventDefault();
			var form_data = new FormData($('.revise_review_form')[0]);
			Swal.fire({
                    title: 'İnceleniyor...',
                    html: '<div style="text-align:center;"><i class="fa fa-spinner fa-spin"></i></div> Lütfen beklermisin incelemeyi kontrol ediyorum...',
					allowOutsideClick: false,
					allowEscapeKey: false,
                    showConfirmButton:false
            });
			$.ajax({
				type: 'POST',
				url: site_url+'/ajax',
				data: form_data,
				processData: false,
				contentType: false,
				dataType: 'json',
				cache: false,
				success: function(data) {
					if(data.status)
					{
						window.location.href=site_url+'/hesabim/incelemeler';
					}
					else
					{
						$('.review_add_content_result').html(error(data.msg));
						Swal.close();
						setTimeout(function(){ scroll_div(".review_form_container"); }, 750);

						
					}
				}
			})
});


function Speech() {
  if ('webkitSpeechRecognition' in window) {
    // creating voice capture object
    this.recognition = new webkitSpeechRecognition();

    // settings
    this.recognition.continuous = false; // stop automatically
    this.recognition.interimResults = false;
    this.recognition.lang = 'tr-TR';

    this.startCapture = function() {
      this.recognition.start();
    }

    this.stopCapture = function() {
      this.recognition.stop();
    }

    this.recognition.onresult = function(event) {
	  if(event.results[0][0].transcript!='')
	  {
		var append_review_content = event.results[0][0].transcript;
		var review_content = $('.'+microphone_write_element+'').val();
		$('.'+microphone_write_element+'').val(''+review_content+' '+append_review_content+'');
	  }
    }

    this.recognition.onerror = function(event) {
		
		$('.microphone_write').removeClass('microphone_write').html('<i class="fa fa-microphone"></i> Mikrofon kullanımı başarısız oldu. Sayfayı yenileyip lütfen tekrar deneyin.');
    }

    
  } else {
	 
       $('.microphone_write').html('<i class="fa fa-microphone"></i> Mikrofon kullanılamıyor. Lütfen izinleri kontrol edin.');
  }
}


$( document ).ready(function() {
    if($('.review_add_card_content').length)
	{
		type_question();
	}
	
	if($('.revise_review').length)
	{
		$('.review_add_content').each(function(index, element) {
		  
			var word_count = $(this).closest('.review_add_step').find('.review_add_content_word_count');
			var need = $(this).closest('.review_add_step').find('.need').html();
			var total = $(this).val().split(/[\s\.\?]+/).length;
			$(this).closest('.review_add_step').find('.total').html(total);
			if(total>=need)
			{
				word_count.addClass('success');
			}
			else
			{
				word_count.removeClass('success');
			}
		  
		  
		});
	}
	
	var sr = window.SpeechRecognition || window.webkitSpeechRecognition || false;
	microphone_write_element = null;
	microphone_status = true;
	if (sr) 
	{
		var speech = new Speech();

		speech.recognition.onstart = function() {

			microphone_status = false;
			$('.microphone_write').html('<i class="fa fa-microphone fa-beat"></i> Mikrofon Dinleniyor...');

		}

		speech.recognition.onend = function(e) {
			
			microphone_status = true;
			$(".microphone_write").html('<i class="fa fa-microphone"></i> Mikrofonu Kullan');
			
		}

		$('.microphone_write').click(function(){
			if (microphone_status) {
				
				microphone_write_element = $(this).attr('rel');
				
				speech.startCapture();
			}
			else {
				
				microphone_write_element = null;
				speech.stopCapture();
			}
		});
	}
	else
	{
		$('.microphone_write').hide();
	}
	
	
});